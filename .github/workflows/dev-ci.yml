name: Docker Build and Push with Dynamic Tag

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: arc-runner-set
    container:
      image: docker:dind
      options: --privileged
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Install make
      - name: Install make
        run: |
          sudo apt-get update
          sudo apt-get install -y make
      # Step 4: Login to DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 5: Build and Push using Makefile with dynamic tag
      - name: Build and Push Docker image
        run: |
          make build-push